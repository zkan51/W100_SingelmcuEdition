#include "main.h"

u8 TIM3_CAM1_flag=0; //防止反复进入
u8 TIM3_CAM3_flag=0; //防止反复进入
u8 TIM3_CAM5_flag=0; //防止反复进入

u16 tim3_cnt;
int tim2_cnt; //定时器2计数
u8 swchflag;
static u8 time4flag=0;
static u16 txLen = 0;
static u8 cmd[8];
static u8 condition  = 0x30; // 发射完成后，返回ready状态
static u8 size_of_FIFO = 64; // 芯片中发射FIFO的容量为64 bytes
static u8 tx_threshold = 40; // FIFO中空出的空间达到40 bytes时，产生TFAE中断

/***********************************************************
 * 函数名: TIM3_NVIC_Configuration
 * 描述  ：配置定时器T3中断
 * 输入  : 无
 * 输出  : 无
 ***********************************************************/
void TIM3_NVIC_Configuration(void)
{
    NVIC_InitTypeDef NVIC_InitStructure; 
    
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
    NVIC_InitStructure.NVIC_IRQChannel = TIM3_IRQn;
    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 3;
    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&NVIC_InitStructure);
}
/***********************************************************
 * 函数名: TIM3_Configuration
 * 描述  ：配置定时器T3
 * 输入  : 无
 * 输出  : 无
 ***********************************************************/
void TIM3_Configuration(void)
{
		TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;
		RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM3 , ENABLE);
		TIM3_NVIC_Configuration();

		TIM_DeInit(TIM3);
		TIM_TimeBaseStructure.TIM_Period=99;		 								
		TIM_TimeBaseStructure.TIM_Prescaler= 9;			//48M/(9+1)*(99+1)=9.6K*5的频率进入中断  
		TIM_TimeBaseStructure.TIM_ClockDivision=TIM_CKD_DIV1; 		
		TIM_TimeBaseStructure.TIM_CounterMode=TIM_CounterMode_Up; 
		TIM_TimeBaseStructure.TIM_RepetitionCounter = 0;
		TIM_TimeBaseInit(TIM3, &TIM_TimeBaseStructure);

	 TIM_ITConfig(TIM3, TIM_IT_Update , ENABLE);	
	 TIM_Cmd(TIM3, ENABLE);	/* 开启时钟 */ 
}
/***********************************************************
 * 函数名: TIM3_OFF
 * 描述  ：关闭定时器T3
 * 输入  : 无
 * 输出  : 无
 ***********************************************************/
void TIM3_OFF(void)
{
	 TIM_ITConfig(TIM3, TIM_IT_Update , DISABLE);	
	 TIM_Cmd(TIM3, DISABLE);	
}
/***********************************************************
 * 函数名: TIM4_Configuration
 * 描述  ：配置定时器T4,外部时钟触发模式，dds方波作为触发
 * 输入  : 无
 * 输出  : 无
 ***********************************************************/
void TIM4_Configuration(void)
{
	  /*GPIO_InitTypeDef GPIO_InitStructure;
		TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;
	
		RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOE, ENABLE);
		RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM4, ENABLE);
		
		GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0;//配置TIM4外部触发IO
		GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING; 
		GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; 
		GPIO_Init(GPIOE, &GPIO_InitStructure);
	
    TIM_DeInit(TIM4);
	
    TIM_TimeBaseStructure.TIM_Period=0xffff;		 								
    TIM_TimeBaseStructure.TIM_Prescaler= 0;				    
    TIM_TimeBaseStructure.TIM_ClockDivision=TIM_CKD_DIV1; 		
    TIM_TimeBaseStructure.TIM_CounterMode=TIM_CounterMode_Up; 
		TIM_TimeBaseStructure.TIM_RepetitionCounter = 0;
    TIM_TimeBaseInit(TIM4, &TIM_TimeBaseStructure);

		TIM_ETRClockMode2Config(TIM4,TIM_ExtTRGPSC_OFF, TIM_ExtTRGPolarity_NonInverted, 0);
		
		TIM_SetCounter( TIM4, 0x00);
		TIM_Cmd(TIM4, ENABLE);	 */
		
		///////////////////////////////////
		TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;
	  NVIC_InitTypeDef         NVIC_InitStructure;
	
		RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM4, ENABLE);
		
    TIM_TimeBaseStructure.TIM_Period=4999;		 								
    TIM_TimeBaseStructure.TIM_Prescaler= 7199;//10KHz计数，计数到5000为500ms				    
    TIM_TimeBaseStructure.TIM_ClockDivision=TIM_CKD_DIV1;
    TIM_TimeBaseStructure.TIM_CounterMode=TIM_CounterMode_Up;
//		TIM_TimeBaseStructure.TIM_RepetitionCounter = 0;
    TIM_TimeBaseInit(TIM4, &TIM_TimeBaseStructure);
	  TIM_ITConfig(TIM4,TIM_IT_Update,ENABLE ); //使能指定的TIM4中断,允许更新中断

		NVIC_InitStructure.NVIC_IRQChannel = TIM4_IRQn; //TIM4
    /*NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=0;
		NVIC_InitStructure.NVIC_IRQChannelSubPriority=3;*/
    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=1;
		NVIC_InitStructure.NVIC_IRQChannelSubPriority=0;
		NVIC_InitStructure.NVIC_IRQChannelCmd=ENABLE;
		NVIC_Init(&NVIC_InitStructure);
		
		TIM_Cmd(TIM4, ENABLE);
}

/***********************************************************
 * 函数名: TIM4_ON
 * 描述  ：开启闭定时器T4
 * 输入  : 无
 * 输出  : 无
 ***********************************************************/
void TIM4_ON(void)
{	
		TIM_Cmd(TIM4, ENABLE);
		//TIM_SetCounter( TIM4, 0x00);
}
/***********************************************************
 * 函数名: TIM4_OFF
 * 描述  ：关闭定时器T4
 * 输入  : 无
 * 输出  : 无
 ***********************************************************/
void TIM4_OFF(void)
{
	 TIM_Cmd(TIM4, DISABLE);
}
//=============================================
void TIM2_NVIC_Configuration(void)
{
  NVIC_InitTypeDef NVIC_InitStructure; 
	 
  NVIC_PriorityGroupConfig(NVIC_PriorityGroup_0);
  NVIC_InitStructure.NVIC_IRQChannel = TIM2_IRQn;	  
  NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;
  NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
  NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
  NVIC_Init(&NVIC_InitStructure);
}

void TIM2_Configuration(void)
{
  TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;
  RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2 , ENABLE);
	TIM2_NVIC_Configuration();
	
  TIM_DeInit(TIM2);
  TIM_TimeBaseStructure.TIM_Period=1999;		 					/* 自动重装载寄存器周期的值(计数值) */
  //TIM_TimeBaseStructure.TIM_Prescaler= (36000 - 1);				    /* 时钟预分频数   例如：时钟频率=72MHZ/(时钟预分频+1) */ //0.5ms
	TIM_TimeBaseStructure.TIM_Prescaler= (24000 - 1);				      /* 时钟预分频数   例如：时钟频率=48MHZ/(时钟预分频+1) */ //0.5ms
  TIM_TimeBaseStructure.TIM_ClockDivision=TIM_CKD_DIV1; 			/* 采样分频 */
  TIM_TimeBaseStructure.TIM_CounterMode=TIM_CounterMode_Up; 		/* 向上计数模式 */
  TIM_TimeBaseInit(TIM2, &TIM_TimeBaseStructure);
  TIM_ClearFlag(TIM2, TIM_FLAG_Update);							    /* 清除溢出中断标志 */
  TIM_ITConfig(TIM2,TIM_IT_Update,ENABLE);
  TIM_Cmd(TIM2, ENABLE);											/* 开启时钟 */
}
//=============================================
/***********************************************************
 * 函数名: TIM3_IRQHandler
 * 描述  ：定时器3中断服务函数，按   频率进入中断，根据查找
           表写dds频率字
 * 输入  : 无
 * 输出  : 无
 ***********************************************************/
void TIM3_IRQHandler(void)
{	
  if (TIM_GetITStatus(TIM3, TIM_IT_Update) != RESET)
  {
		  if(10 == tim3_cnt)	// 打开si4463,1个时隙约20.83us
				{
						if(TIM3_CAM3_flag==0)
						{
							SI4463_ON();
							TIM3_CAM3_flag=1;
						}
				}

			if(1000 == tim3_cnt)  //等待1000个时隙，芯片稳定
			{
					if(TIM3_CAM5_flag == 0) 
					{
							if(swchflag == 0)
							{
									flag_channel = (1-flag_channel); //flag_channel=(AIS_CHANNEL)(1-flag_channel);
									Write_TX_Channel();
								 SI446X_CONFIG_INIT(); 
									txLen = 32;
									msg_send1();//生成消息18
							}
							else if(swchflag == 1)
							{
						  SI446X_CONFIG_INIT(); 
							 txLen = 64;								
								msg_send2();//生成消息24AB
							}
							TIM3_CAM5_flag = 1;
					}
			}
			
			if(1030 == tim3_cnt)  //打开PA
			{
					if(TIM3_CAM1_flag == 0) 
					{
							PA_ON();
							TIM3_CAM1_flag = 1;
					}
			}
			
			if(1230 == tim3_cnt)  //发送时隙到来时开启任务标志
			{
					if(task_flag1!=on)
					{					
							task_flag1=on;
					}
			}

			//
			if(task_flag1==on)  
			{	
					//发送AIS消息
					SI446X_SEND_PACKET(txBuf, txLen, flag_channel, condition, size_of_FIFO, tx_threshold);
				
					task_flag1=off; //没有发送任务在执行
					task_flag2=off;//发送任务完成
					TIM3_CAM5_flag = 0;  //TIM3标记变量清零
					TIM3_CAM3_flag = 0;  //SI4463开启标志
					TIM3_CAM1_flag = 0;  //PA开启标志
				
					tim3_cnt=0;
					
					
					if(swchflag == 0)//消息18 发送结束
					{
					}
					else if(swchflag == 1) //消息24AB发送结束
					{
						TIM_ITConfig(TIM3, TIM_IT_Update , DISABLE);
						TIM_Cmd(TIM3, DISABLE);
					}
					
					SI4463_OFF();
					PA_OFF();
					swchflag ++;
					
					////////////////消息发送结束///////////////
					//判断是否要开GPS，GPS 3分钟开一次
					if(swchflag == 2)
					{
								if (interval_num == 0) // 开GPS
								{
											GPS_ON();
											//TIM4_ON();
											TIM4_Configuration();
											tim2_cnt = 0;
											TIM2_Configuration();
											interval_num++;
											if (intervalA == 0)
														interval_num = 0;
											BKP_WriteBackupRegister(BKP_DR1,interval_num);
								}
								else  //GPS 距上次开启未满3分钟
								{
											if (intervalA == 5) // 发送间隔30s
											{
														interval_num++;
														if (interval_num == 4)
																	interval_num = 0;
														BKP_WriteBackupRegister(BKP_DR1,interval_num);
														RTC_Init();
														PWR_WakeUpPinCmd(ENABLE);
														PWR_EnterSTANDBYMode();
											} 
											else if (intervalA == 2)  // 发送间隔为1分钟
											{
														interval_num++;
														if (interval_num == 2)
																	interval_num = 0;
														BKP_WriteBackupRegister(BKP_DR1,interval_num);
														RTC_Init();
														PWR_WakeUpPinCmd(ENABLE);
														PWR_EnterSTANDBYMode();
											}
											else 
											{
											}
								}
					}
			}
			
		 tim3_cnt++;
		 TIM_ClearITPendingBit(TIM3, TIM_IT_Update);
	}	
}

//
//GPS失效时间判断
//
void TIM2_IRQHandler(void)  
{
	if( TIM_GetITStatus(TIM2 , TIM_IT_Update) != RESET ) 
	{
		tim2_cnt++;
		// 搜GPS时间超过2分钟
		if(tim2_cnt == gps_invalid)     //2min
		{
				TIM_Cmd(TIM2, DISABLE);
				GPS_OFF();
				LED_OFF();
				TIM4_OFF();

			 if(charging_flag == off)
			 {		
						RTC_Init();
						PWR_WakeUpPinCmd(ENABLE);
						PWR_EnterSTANDBYMode();
			 }
		}
				
		TIM_ClearITPendingBit(TIM2 , TIM_FLAG_Update);
	}	
}

//
//开GPS时 绿灯闪
//
void TIM4_IRQHandler(void)
{
	if (TIM_GetITStatus(TIM4, TIM_IT_Update) != RESET)
	{
		  if(battery >= BATTERYLEVEL)
				{
					 if(time4flag == 0)
						{
								LED_ON();
						  time4flag = 1;
						}
						else 
						{
								LED_OFF();
							 time4flag = 0;
						}
				}
				else 
				{
					 if(time4flag == 0)
						{
								LED_RED_ON();
						  time4flag = 1;
						}
						else 
						{
								LED_RED_OFF();
							 time4flag = 0;
						}
				}
			TIM_ClearITPendingBit(TIM4, TIM_IT_Update);
	}
}





